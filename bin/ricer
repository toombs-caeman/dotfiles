#!/usr/bin/env bash

RC="${BASH_SOURCE%/*}/.."
. "$RC/rc.sh" # import opt()

# I took most of the themes in themes/ from [pywal](https://github.com/dylanaraps/pywal)
# the ricer theme format is color 0 - 15, foreground, background, cursor using 6 digit hex codes. 1 color per line.
ricer_load_pywal_themes() {
  for f in *.json; do
    jq "$(fmt '(.colors|{%s}[]),(.special|{foreground,background,cursor}[])%Lcolor%s%I,' {0..15})" "$f" | \
      tr -d '"#' > "${f%%.json}"
  done
  rm *.json
}
ricer() {
  eval "`opt convert,c= theme,t= wallpaper,w= --nargs -d "paste color themes into templates."`"
  # --convert TMPL to change a [dracula](https://spec.draculatheme.com/) template to a ricer template, in-place.
  if [ -n "$theme" ]; then theme="$RC/themes/${theme##*/}"; else theme="$(find "$RC/themes" -type f|shuf|head -n1)"; fi
  if [ ! -f "$theme" ]; then echo "theme '$theme' not found" >&2; return 1; fi
  if [ ! -n "$wallpaper" ]; then wallpaper="$(find ~/Pictures/Wallpapers -type f | shuf | head -n1)"; fi
  if [ ! -f "$wallpaper" ]; then echo "wallpaper '$wallpaper' not found" >&2; return 1; fi
  if [ -n "$convert" ]; then theme="$RC/themes/dracula"; fi

  # load theme
  local sed='' des='' colors=()
  _ricer_sed() { printf -v sed '%ss,{{%s}},%s,g;' "$sed" "$1" "$2";printf -v des '%ss,%s,{{%s}},gi;' "$des" "$2" "$1"; }
  while read line; do colors+=("$line"); done < "$theme"
  for i in {0..15}; do _ricer_sed "color$i" "${colors[$i]}"; done
  _ricer_sed foreground "${colors[16]}"
  _ricer_sed background "${colors[17]}"
  _ricer_sed cursor     "${colors[18]}"
  # convert dracula theme
  if [ -n "$convert" ]; then
    # 'Orange' is the only standard palette color not represented in the ANSI palette. color9 is closest (but pinker)
    _ricer_sed color9 "FFB86C"
    sed -i "$des" "$convert"
    return
  else
    _ricer_sed wallpaper  "${wallpaper//,/\,}" # escape ',' for sed command
  fi
  printf '\e[m%s: <' "${theme##*/}"
  for c in "${colors[@]}"; do : "${c#??}"; printf '\e[0;38;2;%d;%d;%dmâ–ˆ' "0x${c%????}" "0x${_%??}" "0x${_#??}"; done
  printf '\e[m>\n'
  _ricer() { command -v "$1" >/dev/null && sed "$sed" < "$RC/templates/$2" > "$3" && (($#>4)) && "${@:4}" >/dev/null; }
  #      when       template        destination                 callback
  _ricer xrdb       Xresources      ~/.Xresources               xrdb -load ~/.Xresources
  _ricer alacritty  alacritty.yml   ~/.alacritty.yml
  _ricer i3-msg     i3status.conf   ~/.config/i3status/config
  _ricer i3-msg     i3config.sh     ~/.i3/config                i3-msg restart
  # https://github.com/MrOtherGuy/firefox-csshacks/tree/master/chrome
  #  firefox: enable toolkit.legacyUserProfileCustomizations.stylesheets
#  : ~/.mozilla/firefox/*.default/chrome # expand glob pattern
#  _ricer firefox   userChrome.css   "$_/userChrome.css"
}

ricer "$@"